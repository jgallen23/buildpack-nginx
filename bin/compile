#!/usr/bin/env bash
set -e

CACHEDIR=$2
NGINXFILE=nginx_1.2.1-2.2ubuntu0.2_all.deb

if [[ ! -f "$CACHEDIR/$NGINXFILE" ]]; then
  apt-get download nginx
  mv $NGINXFILE $CACHEDIR
fi

dpkg -i $CACHEDIR/$NGINXFILE

BINDIR=$(dirname "$0")

if [[ ! -f $1/nginx.conf.erb ]]; then
    cp $BINDIR/../conf/nginx.conf.erb $1/nginx.conf.erb
fi

if [[ ! -f $1/mime.types ]]; then
	cp $BINDIR/../conf/mime.types $1/mime.types
fi

if [[ -e $1/${CUSTOM_BUILD:-custom-build} ]]; then
    $1/${CUSTOM_BUILD:-custom-build} "$@"
fi
